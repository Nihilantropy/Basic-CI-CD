============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.3.5, pluggy-1.5.0
rootdir: /home/crea/Desktop/Basic-CI-CD/appflask
configfile: pyproject.toml
collected 10 items

tests/test_app.py ..                                                     [ 20%]
tests/test_metrics.py FF...                                              [ 70%]
tests/test_rate_limit.py ...                                             [100%]

=================================== FAILURES ===================================
_________________________ test_metrics_endpoint_exists _________________________

client = <FlaskClient <Flask 'appflask.app'>>

    def test_metrics_endpoint_exists(client):
        """Test that the /metrics endpoint exists and returns a valid response."""
        response = client.get("/metrics")
        assert response.status_code == 200
>       assert response.content_type == 'text/plain; version=0.0.4; charset=utf-8'
E       AssertionError: assert 'text/plain; ...charset=utf-8' == 'text/plain; ...charset=utf-8'
E         
E         - text/plain; version=0.0.4; charset=utf-8
E         + text/plain; version=0.0.4; charset=utf-8; charset=utf-8
E         ?                                         +++++++++++++++

tests/test_metrics.py:27: AssertionError
---------------------------- Captured stderr setup -----------------------------
INFO:appflask.app:Starting Flask application...
DEBUG:appflask.app:Rate limiter initialized
DEBUG:appflask.errors:Error handlers registered successfully
DEBUG:appflask.metrics:Metrics collection initialized
DEBUG:appflask.app:Metrics collection initialized
------------------------------ Captured log setup ------------------------------
INFO     appflask.app:app.py:35 Starting Flask application...
DEBUG    appflask.app:app.py:39 Rate limiter initialized
DEBUG    appflask.errors:errors.py:151 Error handlers registered successfully
DEBUG    appflask.metrics:metrics.py:101 Metrics collection initialized
DEBUG    appflask.app:app.py:46 Metrics collection initialized
_____________________________ test_metrics_content _____________________________

client = <FlaskClient <Flask 'appflask.app'>>

    def test_metrics_content(client):
        """Test that the metrics endpoint returns valid Prometheus metrics."""
        # First make a request to generate some metrics
        client.get("/")
    
        # Then check metrics
        response = client.get("/metrics")
        metrics_data = response.data.decode('utf-8')
    
        # Use prometheus_client parser to validate metrics format
        families = list(text_string_to_metric_families(metrics_data))
    
        # Check that we have metrics
        assert len(families) > 0
    
        # Check for specific metrics
        metric_names = [family.name for family in families]
        expected_metrics = [
            'http_requests_total',
            'http_request_duration_seconds',
            'app_info',
            'app_uptime_seconds',
            'app_start_time_seconds'
        ]
    
        for metric in expected_metrics:
>           assert metric in metric_names, f"Expected metric {metric} not found"
E           AssertionError: Expected metric http_requests_total not found
E           assert 'http_requests_total' in ['python_gc_objects_collected', 'python_gc_objects_uncollectable', 'python_gc_collections', 'python_info', 'process_virtual_memory_bytes', 'process_resident_memory_bytes', ...]

tests/test_metrics.py:55: AssertionError
---------------------------- Captured stderr setup -----------------------------
INFO:appflask.app:Starting Flask application...
DEBUG:appflask.app:Rate limiter initialized
DEBUG:appflask.errors:Error handlers registered successfully
DEBUG:appflask.metrics:Metrics collection initialized
DEBUG:appflask.app:Metrics collection initialized
------------------------------ Captured log setup ------------------------------
INFO     appflask.app:app.py:35 Starting Flask application...
DEBUG    appflask.app:app.py:39 Rate limiter initialized
DEBUG    appflask.errors:errors.py:151 Error handlers registered successfully
DEBUG    appflask.metrics:metrics.py:101 Metrics collection initialized
DEBUG    appflask.app:app.py:46 Metrics collection initialized
----------------------------- Captured stderr call -----------------------------
DEBUG:appflask.routes:Handling / request, agent: Unknown, time: 14:43, version: ${PLACEHOLDER_VERSION}
------------------------------ Captured log call -------------------------------
DEBUG    appflask.routes:routes.py:34 Handling / request, agent: Unknown, time: 14:43, version: ${PLACEHOLDER_VERSION}
=========================== short test summary info ============================
FAILED tests/test_metrics.py::test_metrics_endpoint_exists - AssertionError: ...
FAILED tests/test_metrics.py::test_metrics_content - AssertionError: Expected...
========================= 2 failed, 8 passed in 5.64s ==========================
